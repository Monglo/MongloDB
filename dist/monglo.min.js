function Cursor(db,collection,selector,fields,skip,limit,sort){this.db=db,this.collection=collection,this.selector=selector,this.fields=fields,this.skipValue=skip===null?0:skip,this.limitValue=limit===null?0:limit,this.sortValue=sort,typeof this.selector=="string"||typeof this.selector=="number"?(this.selector_id=this.selector,this.selector_f=Selector._compileSelector(this.selector)):(this.selector_f=Selector._compileSelector(this.selector),this.sort_f=this.sortValue?Collection._compileSort(this.sortValue):null),this.db_objects=null,this.cursor_pos=0}function validateDatabaseName(databaseName){if(typeof databaseName!="string")throw new Error("database name must be a string");if(databaseName.length===0)throw new Error("database name cannot be the empty string");var invalidChars=[" ",".","$","/","\\"];for(var i=0;i<invalidChars.length;i++)if(databaseName.indexOf(invalidChars[i])!=-1)throw new Error("database names cannot contain the character '"+invalidChars[i]+"'")}function BinaryParser(bigEndian,allowExceptions){if(!(this instanceof BinaryParser))return new BinaryParser(bigEndian,allowExceptions);this.bigEndian=bigEndian,this.allowExceptions=allowExceptions}function BinaryParserBuffer(bigEndian,buffer){this.bigEndian=bigEndian||0,this.buffer=[],this.setBuffer(buffer)}function Collection(db,collectionName,pkFactory,options){if(!(this instanceof Collection))return new Collection(db,collectionName,pkFactory,options);checkCollectionName(collectionName),this.db=db,this.collectionName=collectionName,this.docs={},this.snapshots=[],this.opts=options!=null&&"object"==typeof options?options:{};var self=this}function EventEmitter(){}Cursor.prototype.rewind=function(){var self=this;self.db_objects=null,self.cursor_pos=0},Cursor.prototype.forEach=function(callback){var self=this,doc;self.db_objects===null&&(self.db_objects=self._getRawObjects());while(self.cursor_pos<self.db_objects.length)callback(utils._deepcopy(self.db_objects[self.cursor_pos++]))},Cursor.prototype.map=function(callback){var self=this,res=[];return self.forEach(function(doc){res.push(callback(doc))}),res},Cursor.prototype.fetch=function(){var self=this,res=[];return self.forEach(function(doc){res.push(doc)}),res},Cursor.prototype.count=function(){var self=this;return self.db_objects===null&&(self.db_objects=self._getRawObjects()),self.db_objects.length},Cursor.prototype.sort=function(){},Cursor.prototype.limit=function(){},Cursor.prototype._getRawObjects=function(){var self=this;if(self.selector_id&&self.selector_id in self.collection.docs)return[self.collection.docs[self.selector_id]];var results=[];for(var id in self.collection.docs){var doc=self.collection.docs[id];self.selector_f(doc)&&results.push(doc)}self.sort_f&&results.sort(self.sort_f);var idx_start=self.skipValue||0,idx_end=self.limitValue?self.limitValue+idx_start:results.length;return results.slice(idx_start,idx_end)};var Monglo=function(databaseName){if(!(this instanceof Monglo))return new Monglo(databaseName);this._collections={},this._stores=[],Monglo.connections||(Monglo.connections={});if(Monglo.connections[databaseName])throw new Error("db name already in use");this.databaseName=databaseName,Monglo.connections[databaseName]=new ObjectID,validateDatabaseName(databaseName)};Monglo.prototype.__proto__=EventEmitter.proto,Monglo.prototype.constructor=Monglo,Monglo.version="0.1.2",Monglo._debug=function(){},Monglo.connections={},Monglo.prototype._executeCommand=function(name,args,cb){var self=this,command=name;utils.forEach(self._stores,function(fn){"function"==typeof fn[command]?fn[command](self,args,cb):"function"==typeof fn.all&&(args.name=name,fn.all(self,args,cb))})},Monglo.prototype.use=function(name,fn){switch(name){case"sync":this._sync=fn;break;case"store":this._stores.push(fn);break;case"debug":Monglo._debug=fn}},Monglo.prototype.addStore=function(store){return this._stores.push(store),this},Monglo.prototype.collectionsInfo=function(collectionName,callback){},Monglo.prototype.collectionNames=function(collectionName,options,callback){var self=this,args=Array.prototype.slice.call(arguments,0);callback=args.pop(),collectionName=args.length?args.shift():null,options=args.length?args.shift():{};var collectionList=[];for(var name in self._collections)collectionList.push(name);callback(null,collectionList)},Monglo.prototype.collection=function(collectionName,options,callback){var self=this,collection,collectionFullName=self.databaseName+"."+collectionName;return"function"==typeof options?(options={},callback=options):options=options||{},self._collections[collectionName]?(self._executeCommand("createCollection",{conn:self,collection:self._collections[collectionName]}),callback(null,self._collections[collectionName])):(self._collections[collectionName]=new Collection(self,collectionName,self.pkFactory,options),self._executeCommand("createCollection",{conn:self,collection:self._collections[collectionName]}),Object.defineProperty(Monglo.prototype,collectionName,{enumerable:!0,get:function(){return self._collections[collectionName]},set:function(v){self._collections[collectionName]=v}}),callback?callback(self._collections[collectionName]):self._collections[collectionName])},Monglo.prototype.collections=function(callback){var self=this;self.collectionNames(function(err,documents){if(err!=null)return callback(err,null);var collections=[];utils.forEach(documents,function(document){collections.push(new Collection(self,document.name.replace(self.databaseName+".",""),self.pkFactory))}),callback(null,collections)})},Monglo.prototype.dereference=function(dbRef,callback){var db=this;dbRef.db!==null&&(db=this.db(dbRef.db));var collection=Monglo.collection(dbRef.namespace);collection.findOne({_id:dbRef.oid},function(err,result){callback(err,result)})},Monglo.prototype.createCollection=Monglo.prototype.collection,Monglo.prototype.dropCollection=function(collectionName,callback){var self=this;this._executeCommand("dropCollection",{conn:this,collection:self})},Monglo.prototype.renameCollection=function(fromCollection,toCollection,callback){var self=this;this._executeCommand("renameCollection",{conn:self,from:fromCollection,to:toCollection})},Monglo.prototype.createIndex=function(collectionName,fieldOrSpec,options,callback){throw new Error("Not implemented yet!")},Monglo.prototype.ensureIndex=function(collectionName,fieldOrSpec,options,callback){throw new Error("Not implemented yet!")},Monglo.prototype.dropIndex=function(collectionName,indexName,callback){throw new Error("Not implemented yet!")},Monglo.prototype.reIndex=function(collectionName,callback){throw new Error("Not implemented yet!")},Monglo.prototype.indexInformation=function(collectionName,options,callback){throw new Error("Not implemented yet!")},Monglo.prototype.dropDatabase=function(callback){var self=this;this._executeCommand("dropDatabase",{conn:this})},exports.Monglo=Monglo;var chr=String.fromCharCode,maxBits=[];for(var i=0;i<64;i++)maxBits[i]=Math.pow(2,i);BinaryParser.warn=function warn(msg){if(this.allowExceptions)throw new Error(msg);return 1},BinaryParser.decodeFloat=function decodeFloat(data,precisionBits,exponentBits){var b=new this.Buffer(this.bigEndian,data);b.checkBuffer(precisionBits+exponentBits+1);var bias=maxBits[exponentBits-1]-1,signal=b.readBits(precisionBits+exponentBits,1),exponent=b.readBits(precisionBits,exponentBits),significand=0,divisor=2,curByte=b.buffer.length+(-precisionBits>>3)-1;do for(var byteValue=b.buffer[++curByte],startBit=precisionBits%8||8,mask=1<<startBit;mask>>=1;byteValue&mask&&(significand+=1/divisor),divisor*=2);while(precisionBits-=startBit);return exponent==(bias<<1)+1?significand?NaN:signal?-Infinity:+Infinity:(1+signal*-2)*(exponent||significand?exponent?Math.pow(2,exponent-bias)*(1+significand):Math.pow(2,-bias+1)*significand:0)},BinaryParser.decodeInt=function decodeInt(data,bits,signed,forceBigEndian){var b=new this.Buffer(this.bigEndian||forceBigEndian,data),x=b.readBits(0,bits),max=maxBits[bits];return signed&&x>=max/2?x-max:x},BinaryParser.encodeFloat=function encodeFloat(data,precisionBits,exponentBits){var bias=maxBits[exponentBits-1]-1,minExp=-bias+1,maxExp=bias,minUnnormExp=minExp-precisionBits,n=parseFloat(data),status=isNaN(n)||n==-Infinity||n==+Infinity?n:0,exp=0,len=2*bias+1+precisionBits+3,bin=new Array(len),signal=(n=status!==0?0:n)<0,intPart=Math.floor(n=Math.abs(n)),floatPart=n-intPart,lastBit,rounded,result,i,j;for(i=len;i;bin[--i]=0);for(i=bias+2;intPart&&i;bin[--i]=intPart%2,intPart=Math.floor(intPart/2));for(i=bias+1;floatPart>0&&i;(bin[++i]=((floatPart*=2)>=1)-0)&&--floatPart);for(i=-1;++i<len&&!bin[i];);if(bin[(lastBit=precisionBits-1+(i=(exp=bias+1-i)>=minExp&&exp<=maxExp?i+1:bias+1-(exp=minExp-1)))+1]){if(!(rounded=bin[lastBit]))for(j=lastBit+2;!rounded&&j<len;rounded=bin[j++]);for(j=lastBit+1;rounded&&--j>=0;(bin[j]=!bin[j]-0)&&(rounded=0));}for(i=i-2<0?-1:i-3;++i<len&&!bin[i];);(exp=bias+1-i)>=minExp&&exp<=maxExp?++i:exp<minExp&&(exp!=bias+1-len&&exp<minUnnormExp&&this.warn("encodeFloat::float underflow"),i=bias+1-(exp=minExp-1));if(intPart||status!==0)this.warn(intPart?"encodeFloat::float overflow":"encodeFloat::"+status),exp=maxExp+1,i=bias+2,status==-Infinity?signal=1:isNaN(status)&&(bin[i]=1);for(n=Math.abs(exp+bias),j=exponentBits+1,result="";--j;result=n%2+result,n=n>>=1);for(n=0,j=0,i=(result=(signal?"1":"0")+result+bin.slice(i,i+precisionBits).join("")).length,r=[];i;j=(j+1)%8)n+=(1<<j)*result.charAt(--i),j==7&&(r[r.length]=String.fromCharCode(n),n=0);return r[r.length]=n?String.fromCharCode(n):"",(this.bigEndian?r.reverse():r).join("")},BinaryParser.encodeInt=function encodeInt(data,bits,signed,forceBigEndian){var max=maxBits[bits];if(data>=max||data<-(max/2))this.warn("encodeInt::overflow"),data=0;data<0&&(data+=max);for(var r=[];data;r[r.length]=String.fromCharCode(data%256),data=Math.floor(data/256));for(bits=-(-bits>>3)-r.length;bits--;r[r.length]="\0");return(this.bigEndian||forceBigEndian?r.reverse():r).join("")},BinaryParser.toSmall=function(data){return this.decodeInt(data,8,!0)},BinaryParser.fromSmall=function(data){return this.encodeInt(data,8,!0)},BinaryParser.toByte=function(data){return this.decodeInt(data,8,!1)},BinaryParser.fromByte=function(data){return this.encodeInt(data,8,!1)},BinaryParser.toShort=function(data){return this.decodeInt(data,16,!0)},BinaryParser.fromShort=function(data){return this.encodeInt(data,16,!0)},BinaryParser.toWord=function(data){return this.decodeInt(data,16,!1)},BinaryParser.fromWord=function(data){return this.encodeInt(data,16,!1)},BinaryParser.toInt=function(data){return this.decodeInt(data,32,!0)},BinaryParser.fromInt=function(data){return this.encodeInt(data,32,!0)},BinaryParser.toLong=function(data){return this.decodeInt(data,64,!0)},BinaryParser.fromLong=function(data){return this.encodeInt(data,64,!0)},BinaryParser.toDWord=function(data){return this.decodeInt(data,32,!1)},BinaryParser.fromDWord=function(data){return this.encodeInt(data,32,!1)},BinaryParser.toQWord=function(data){return this.decodeInt(data,64,!0)},BinaryParser.fromQWord=function(data){return this.encodeInt(data,64,!0)},BinaryParser.toFloat=function(data){return this.decodeFloat(data,23,8)},BinaryParser.fromFloat=function(data){return this.encodeFloat(data,23,8)},BinaryParser.toDouble=function(data){return this.decodeFloat(data,52,11)},BinaryParser.fromDouble=function(data){return this.encodeFloat(data,52,11)},BinaryParser.encode_int32=function encode_int32(number,asArray){var a,b,c,d,unsigned;return unsigned=number<0?number+4294967296:number,a=Math.floor(unsigned/16777215),unsigned&=16777215,b=Math.floor(unsigned/65535),unsigned&=65535,c=Math.floor(unsigned/255),unsigned&=255,d=Math.floor(unsigned),asArray?[chr(a),chr(b),chr(c),chr(d)]:chr(a)+chr(b)+chr(c)+chr(d)},BinaryParser.encode_int64=function encode_int64(number){var a,b,c,d,e,f,g,h,unsigned;return unsigned=number<0?number+0x10000000000000000:number,a=Math.floor(unsigned/72057594037927940),unsigned&=72057594037927940,b=Math.floor(unsigned/0xffffffffffff),unsigned&=0xffffffffffff,c=Math.floor(unsigned/0xffffffffff),unsigned&=0xffffffffff,d=Math.floor(unsigned/4294967295),unsigned&=4294967295,e=Math.floor(unsigned/16777215),unsigned&=16777215,f=Math.floor(unsigned/65535),unsigned&=65535,g=Math.floor(unsigned/255),unsigned&=255,h=Math.floor(unsigned),chr(a)+chr(b)+chr(c)+chr(d)+chr(e)+chr(f)+chr(g)+chr(h)},BinaryParser.decode_utf8=function decode_utf8(binaryStr){var len=binaryStr.length,decoded="",i=0,c=0,c1=0,c2=0,c3;while(i<len)c=binaryStr.charCodeAt(i),c<128?(decoded+=String.fromCharCode(c),i++):c>191&&c<224?(c2=binaryStr.charCodeAt(i+1),decoded+=String.fromCharCode((c&31)<<6|c2&63),i+=2):(c2=binaryStr.charCodeAt(i+1),c3=binaryStr.charCodeAt(i+2),decoded+=String.fromCharCode((c&15)<<12|(c2&63)<<6|c3&63),i+=3);return decoded},BinaryParser.encode_cstring=function encode_cstring(s){return unescape(encodeURIComponent(s))+BinaryParser.fromByte(0)},BinaryParser.encode_utf8=function encode_utf8(s){var a="",c;for(var n=0,len=s.length;n<len;n++)c=s.charCodeAt(n),c<128?a+=String.fromCharCode(c):c>127&&c<2048?(a+=String.fromCharCode(c>>6|192),a+=String.fromCharCode(c&63|128)):(a+=String.fromCharCode(c>>12|224),a+=String.fromCharCode(c>>6&63|128),a+=String.fromCharCode(c&63|128));return a},BinaryParser.hprint=function hprint(s){var number;for(var i=0,len=s.length;i<len;i++)s.charCodeAt(i)<32?(number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(16):s.charCodeAt(i).toString(16),process.stdout.write(number+" ")):(number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(16):s.charCodeAt(i).toString(16),process.stdout.write(number+" "));process.stdout.write("\n\n")},BinaryParser.ilprint=function hprint(s){var number;for(var i=0,len=s.length;i<len;i++)s.charCodeAt(i)<32?number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(10):s.charCodeAt(i).toString(10):number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(10):s.charCodeAt(i).toString(10)},BinaryParser.hlprint=function hprint(s){var number;for(var i=0,len=s.length;i<len;i++)s.charCodeAt(i)<32?number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(16):s.charCodeAt(i).toString(16):number=s.charCodeAt(i)<=15?"0"+s.charCodeAt(i).toString(16):s.charCodeAt(i).toString(16)},BinaryParserBuffer.prototype.setBuffer=function setBuffer(data){var l,i,b;if(data){i=l=data.length,b=this.buffer=new Array(l);for(;i;b[l-i]=data.charCodeAt(--i));this.bigEndian&&b.reverse()}},BinaryParserBuffer.prototype.hasNeededBits=function hasNeededBits(neededBits){return this.buffer.length>=-(-neededBits>>3)},BinaryParserBuffer.prototype.checkBuffer=function checkBuffer(neededBits){if(!this.hasNeededBits(neededBits))throw new Error("checkBuffer::missing bytes")},BinaryParserBuffer.prototype.readBits=function readBits(start,length){function shl(a,b){for(;b--;a=((a%=2147483647+1)&1073741824)==1073741824?a*2:(a-1073741824)*2+2147483647+1);return a}if(start<0||length<=0)return 0;this.checkBuffer(start+length);var offsetLeft,offsetRight=start%8,curByte=this.buffer.length-(start>>3)-1,lastByte=this.buffer.length+(-(start+length)>>3),diff=curByte-lastByte,sum=(this.buffer[curByte]>>offsetRight&(1<<(diff?8-offsetRight:length))-1)+(diff&&(offsetLeft=(start+length)%8)?(this.buffer[lastByte++]&(1<<offsetLeft)-1)<<(diff--<<3)-offsetRight:0);for(;diff;sum+=shl(this.buffer[lastByte++],(diff--<<3)-offsetRight));return sum},BinaryParser.Buffer=BinaryParserBuffer,typeof window=="undefined"&&(exports.BinaryParser=BinaryParser);var MACHINE_ID=parseInt(Math.random()*16777215,10),checkForHexRegExp=new RegExp("^[0-9a-fA-F]{24}$"),ObjectID=function ObjectID(id,_hex){if(!(this instanceof ObjectID))return new ObjectID(id,_hex);this._bsontype="ObjectID";var __id=null;if(id!=null&&"number"!=typeof id&&id.length!=12&&id.length!=24)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");if(id==null||typeof id=="number")this.id=this.generate(id);else if(id!=null&&id.length===12)this.id=id;else{if(checkForHexRegExp.test(id))return ObjectID.createFromHexString(id);if(!checkForHexRegExp.test(id))throw new Error("Value passed in is not a valid 24 character hex string")}ObjectID.cacheHexString&&(this.__id=this.toHexString())},ObjectId=ObjectID;ObjectID.prototype.toHexString=function(){if(ObjectID.cacheHexString&&this.__id)return this.__id;var hexString="",number,value;for(var index=0,len=this.id.length;index<len;index++)value=BinaryParser.toByte(this.id[index]),number=value<=15?"0"+value.toString(16):value.toString(16),hexString+=number;return ObjectID.cacheHexString&&(this.__id=hexString),hexString},ObjectID.prototype.get_inc=function(){return ObjectID.index=(ObjectID.index+1)%16777215},ObjectID.prototype.getInc=function(){return this.get_inc()},ObjectID.prototype.generate=function(time){if("number"==typeof time)var time4Bytes=BinaryParser.encodeInt(time,32,!0,!0),machine3Bytes=BinaryParser.encodeInt(MACHINE_ID,24,!1),pid2Bytes=BinaryParser.fromShort(typeof process=="undefined"?Math.floor(Math.random()*1e5):process.pid),index3Bytes=BinaryParser.encodeInt(this.get_inc(),24,!1,!0);else var unixTime=parseInt(Date.now()/1e3,10),time4Bytes=BinaryParser.encodeInt(unixTime,32,!0,!0),machine3Bytes=BinaryParser.encodeInt(MACHINE_ID,24,!1),pid2Bytes=BinaryParser.fromShort(typeof process=="undefined"?Math.floor(Math.random()*1e5):process.pid),index3Bytes=BinaryParser.encodeInt(this.get_inc(),24,!1,!0);return time4Bytes+machine3Bytes+pid2Bytes+index3Bytes},ObjectID.prototype.toString=function(){return this.toHexString()},ObjectID.prototype.inspect=ObjectID.prototype.toString,ObjectID.prototype.toJSON=function(){return this.toHexString()},ObjectID.prototype.equals=function equals(otherID){var id=otherID instanceof ObjectID||otherID.toHexString?otherID.id:ObjectID.createFromHexString(otherID).id;return this.id===id},ObjectID.prototype.getTimestamp=function(){var timestamp=new Date;return timestamp.setTime(Math.floor(BinaryParser.decodeInt(this.id.substring(0,4),32,!0,!0))*1e3),timestamp},ObjectID.index=0,ObjectID.createPk=function createPk(){return new ObjectID},ObjectID.createFromTime=function createFromTime(time){var id=BinaryParser.encodeInt(time,32,!0,!0)+BinaryParser.encodeInt(0,64,!0,!0);return new ObjectID(id)},ObjectID.createFromHexString=function createFromHexString(hexString){if(typeof hexString=="undefined"||hexString!=null&&hexString.length!=24)throw new Error("Argument passed in must be a single String of 12 bytes or a string of 24 hex characters");var len=hexString.length;if(len>24)throw new Error("Id cannot be longer than 12 bytes");var result="",string,number;for(var index=0;index<len;index+=2)string=hexString.substr(index,2),number=parseInt(string,16),result+=BinaryParser.fromByte(number);return new ObjectID(result,hexString)},Object.defineProperty(ObjectID.prototype,"generationTime",{enumerable:!0,get:function(){return Math.floor(BinaryParser.decodeInt(this.id.substring(0,4),32,!0,!0))},set:function(value){var value=BinaryParser.encodeInt(value,32,!0,!0);this.id=value+this.id.substr(4),this.toHexString()}}),exports.ObjectID=ObjectID,exports.ObjectId=ObjectID,Collection.prototype.__proto__=EventEmitter.prototype,Collection.prototype.constructor=Collection;var testForFields={limit:1,sort:1,fields:1,skip:1,hint:1,explain:1,snapshot:1,timeout:1,tailable:1,batchSize:1,raw:1,read:1,returnKey:1,maxScan:1,min:1,max:1,showDiskLoc:1,comment:1,dbName:1,exhaust:1,tailableRetryInterval:1};Collection.prototype.find=function(){var self=this,options,args=Array.prototype.slice.call(arguments,0),has_callback=typeof args[args.length-1]=="function",has_weird_callback=typeof args[0]=="function",callback=has_callback?args.pop():has_weird_callback?args.shift():null,len=args.length,selector=len>=1?args[0]:{},fields=len>=2?args[1]:undefined;len===1&&has_weird_callback&&(selector={},options=args[0]);if(len===2&&!utils.isArray(fields)){var fieldKeys=Object.getOwnPropertyNames(fields),is_option=!1;for(var i=0;i<fieldKeys.length;i++)if(testForFields[fieldKeys[i]]!=null){is_option=!0;break}is_option?(options=fields,fields=undefined):options={}}else if(len===2&&utils.isArray(fields)&&!utils.isArray(fields[0])){var newFields={};for(var i=0;i<fields.length;i++)newFields[fields[i]]=1;fields=newFields}3===len&&(options=args[2]),selector=selector==null?{}:selector;var object=selector,object=fields;selector instanceof ObjectID&&(selector={_id:selector});if(options&&options.fields){fields={};if(utils.isArray(options.fields))if(!options.fields.length)fields._id=1;else for(var i=0,l=options.fields.length;i<l;i++)fields[options.fields[i]]=1;else fields=options.fields}options||(options={}),options.skip=len>3?args[2]:options.skip?options.skip:0,options.limit=len>3?args[3]:options.limit?options.limit:0;var o=options,cursor=new Cursor(this.db,this,selector,fields,o.skip,o.limit,o.sort);return this.emit("find",selector,cursor,o),this.db._executeCommand("find",{conn:self.db,selector:selector,options:o}),callback?callback(cursor):cursor},Collection.prototype.findOne=function(selector,options){return arguments.length===0&&(selector={}),this.find(selector).fetch()[0]},Collection.prototype.insert=function(doc,options,cb){var self=this;"function"==typeof options&&(cb=options,options={}),options=options||{},doc=utils._deepcopy(doc),"_id"in doc||(doc._id=new ObjectId),doc.timestamp=(new ObjectId).generationTime,self.docs[doc._id]=doc;for(var qid in self.queries){var query=self.queries[qid];query.selector_f(doc)&&Collection._insertInResults(query,doc)}return options.ignore?cb?cb(doc):doc:(self.emit("insert",doc),this.db._executeCommand("insert",{conn:self.db,collection:self,doc:self.docs[doc._id]}),cb?cb(doc):doc)},Collection.prototype.remove=function(selector){var self=this,remove=[],query_remove=[],selector_f=Selector._compileSelector(selector);for(var id in self.docs){var doc=self.docs[id];selector_f(doc)&&remove.push(id)}for(var i=0;i<remove.length;i++)delete self.docs[remove[i]];return self.emit("remove",selector),this.db._executeCommand("remove",{conn:self.db,selector:selector,docs:remove}),this},Collection.prototype.update=function(selector,mod,options,cb){var self=this;"function"==typeof options&&(cb=options,options={}),options=options||{};var self=this,any=!1,updatedDocs=[],selector_f=Selector._compileSelector(selector);for(var id in self.docs){var doc=self.docs[id];if(selector_f(doc)){updatedDocs.push(doc),Collection._modify(doc,mod);if(!options.multi)return any=!0,self.emit("update",selector,mod,options),self.db._executeCommand("update",{conn:self.db,selector:selector,modifier:mod,options:options,docs:updatedDocs}),cb?cb(self.docs[id]):self.docs[id]}}if(options.upsert)throw new Error("upsert not yet implemented");options.upsert&&!any&&(insert=utils._deepcopy(selector),Collection._modify(insert,mod),self.insert(insert,{ignore:!0}));var newDoc=self.find(selector).fetch();return self.emit("update",selector,mod,options),self.db._executeCommand("update",{conn:self.db,selector:selector,modifier:mod,options:options,docs:newDoc}),cb?cb(newDoc):newDoc},Collection.prototype.save=function(obj,cb){var self=this;self.docs[obj._id]?self.update({_id:obj._id}):self.insert(obj)},Collection.prototype.ensureIndex=function(){throw new Error("Collection#ensureIndex unimplemented by driver")},Collection.prototype.backup=function(){var snapID=new ObjectId;this.snapshots[snapID]={};for(var id in this.docs)this.snapshots[snapID][id]=this.docs[id];this.stores.snapshot({_id:this.docs[id],data:this.docs[id]}),this.emit("snapshot",{_id:this.docs[id],data:this.docs[id]})},Collection.prototype.backups=function(){var keys=[];for(var k in obj)keys.push({id:k,timestamp:ObjectId.hexToTimestamp(k),data:obj[k]});return keys},Collection.prototype.deleteBackup=function(id){return delete this.snapshots[id],keys},Collection.prototype.restore=function(id,rm,cb){if(!this.snapshots.length)throw new Error("No current snapshot");"function"==typeof rm&&(cb=rm,rm=!1),this.docs=this.snapshots[id||0];for(var qid in this.queries){var query=this.queries[qid],old_results=query.results;query.results=query.cursor._getRawObjects(),this.paused||Collection._diffQuery(old_results,query.results,query,!0)}this.emit("restore");if(cb)return cb()};var checkCollectionName=function checkCollectionName(collectionName){if("string"!=typeof collectionName)throw Error("collection name must be a String");if(!collectionName||collectionName.indexOf("..")!=-1)throw Error("collection names cannot be empty");if(collectionName.indexOf("$")!=-1&&collectionName.match(/((^\$cmd)|(oplog\.\$main))/)==null)throw Error("collection names must not contain '$'");if(collectionName.match(/^\.|\.$/)!=null)throw Error("collection names must not start or end with '.'")};Collection._diffQuery=function(old_results,new_results,observer,deepcopy){var new_presence_of_id={};_.each(new_results,function(doc){new_presence_of_id[doc._id]&&utils.debug("Duplicate _id in new_results"),new_presence_of_id[doc._id]=!0});var old_index_of_id={};_.each(old_results,function(doc,i){doc._id in old_index_of_id&&utils.debug("Duplicate _id in old_results"),old_index_of_id[doc._id]=i});var mdc=deepcopy?Collection._deepcopy:_.identity,unmoved_set={},max_seq_len=0,N=new_results.length,seq_ends=new Array(N),ptrs=new Array(N),old_idx_seq=function(i_new){return old_index_of_id[new_results[i_new]._id]};for(var i=0;i<N;i++)if(old_index_of_id[new_results[i]._id]!==undefined){var j=max_seq_len;while(j>0){if(old_idx_seq(seq_ends[j-1])<old_idx_seq(i))break;j--}ptrs[i]=j===0?-1:seq_ends[j-1],seq_ends[j]=i,j+1>max_seq_len&&(max_seq_len=j+1)}var idx=max_seq_len===0?-1:seq_ends[max_seq_len-1];while(idx>=0)unmoved_set[idx]=!0,idx=ptrs[idx];var old_idx=0,new_idx=0,bump_list=[],bump_list_old_idx=[],taken_list=[],scan_to=function(old_j){while(old_idx<old_j){var old_doc=old_results[old_idx],is_in_new=new_presence_of_id[old_doc._id];is_in_new?taken_list.length>=1&&taken_list[0]===old_idx?taken_list.shift():(bump_list.push(new_idx),bump_list_old_idx.push(old_idx)):observer.removed&&observer.removed(old_doc,new_idx+bump_list.length),old_idx++}};while(new_idx<=new_results.length){if(new_idx<new_results.length){var new_doc=new_results[new_idx],old_doc_idx=old_index_of_id[new_doc._id];if(old_doc_idx===undefined)observer.added&&observer.added(mdc(new_doc),new_idx+bump_list.length);else{var old_doc=old_results[old_doc_idx],is_unmoved=unmoved_set[new_idx];if(is_unmoved)old_doc_idx<old_idx&&utils.debug("Assertion failed while diffing: nonmonotonic lcs data"),scan_to(old_doc_idx),_.isEqual(old_doc,new_doc)||observer.changed&&observer.changed(mdc(new_doc),new_idx+bump_list.length,old_doc),old_idx++;else{var to_idx=new_idx+bump_list.length,from_idx;if(old_doc_idx>=old_idx){from_idx=to_idx+old_doc_idx-old_idx;var num_taken_before=_.sortedIndex(taken_list,old_doc_idx);from_idx-=num_taken_before,taken_list.splice(num_taken_before,0,old_doc_idx)}else{var b=_.indexOf(bump_list_old_idx,old_doc_idx,!0);b<0&&utils.debug("Assertion failed while diffing: no bumped item"),from_idx=bump_list[b]+b,to_idx--,bump_list.splice(b,1),bump_list_old_idx.splice(b,1)}from_idx!=to_idx&&observer.moved&&observer.moved(mdc(old_doc),from_idx,to_idx),_.isEqual(old_doc,new_doc)||observer.changed&&observer.changed(mdc(new_doc),to_idx,old_doc)}}}else scan_to(old_results.length);new_idx++}bump_list.length>0&&(utils.debug(old_results),utils.debug(new_results),utils.debug("Assertion failed while diffing: leftover bump_list "+bump_list))};var isArray=Array.isArray,domain;exports.EventEmitter=EventEmitter;var defaultMaxListeners=10;EventEmitter.prototype.setMaxListeners=function(n){this._events||(this._events={}),this._maxListeners=n},EventEmitter.prototype.emit=function(){var type=arguments[0];if(type==="error")if(!this._events||!this._events.error||isArray(this._events.error)&&!this._events.error.length)throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var handler=this._events[type];if(!handler)return!1;if(typeof handler=="function"){switch(arguments.length){case 1:handler.call(this);break;case 2:handler.call(this,arguments[1]);break;case 3:handler.call(this,arguments[1],arguments[2]);break;default:var l=arguments.length,args=new Array(l-1);for(var i=1;i<l;i++)args[i-1]=arguments[i];handler.apply(this,args)}return!0}if(isArray(handler)){var l=arguments.length,args=new Array(l-1);for(var i=1;i<l;i++)args[i-1]=arguments[i];var listeners=handler.slice();for(var i=0,l=listeners.length;i<l;i++)listeners[i].apply(this,args);return!0}return!1},EventEmitter.prototype.addListener=function(type,listener){if("function"!=typeof listener)throw new Error("addListener only takes instances of Function");this._events||(this._events={}),this.emit("newListener",type,typeof listener.listener=="function"?listener.listener:listener),this._events[type]?isArray(this._events[type])?this._events[type].push(listener):this._events[type]=[this._events[type],listener]:this._events[type]=listener;if(isArray(this._events[type])&&!this._events[type].warned){var m;this._maxListeners!==undefined?m=this._maxListeners:m=defaultMaxListeners,m&&m>0&&this._events[type].length>m&&(this._events[type].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[type].length),console.trace())}return this},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.once=function(type,listener){function g(){self.removeListener(type,g),listener.apply(this,arguments)}if("function"!=typeof listener)throw new Error(".once only takes instances of Function");var self=this;return g.listener=listener,self.on(type,g),this},EventEmitter.prototype.removeListener=function(type,listener){if("function"!=typeof listener)throw new Error("removeListener only takes instances of Function");if(!this._events||!this._events[type])return this;var list=this._events[type];if(isArray(list)){var position=-1;for(var i=0,length=list.length;i<length;i++)if(list[i]===listener||list[i].listener&&list[i].listener===listener){position=i;break}if(position<0)return this;list.splice(position,1)}else(list===listener||list.listener&&list.listener===listener)&&delete this._events[type];return this},EventEmitter.prototype.removeAllListeners=function(type){return arguments.length===0?(this._events={},this):(type&&this._events&&this._events[type]&&(this._events[type]=null),this)},EventEmitter.prototype.listeners=function(type){return this._events||(this._events={}),this._events[type]||(this._events[type]=[]),isArray(this._events[type])||(this._events[type]=[this._events[type]]),this._events[type]},Collection._modify=function(doc,mod){var is_modifier=!1;for(var k in mod){is_modifier=k.substr(0,1)==="$";break}var new_doc;if(!is_modifier){mod._id&&doc._id!==mod._id&&Monglo._debug("_id ignored : Cannot change the _id of a document");for(var k in mod){if(k.substr(0,1)==="$")throw Error("Field name may not start with '$'");if(/\./.test(k))throw Error("Field name may not contain '.'")}new_doc=mod}else{var new_doc=Collection._deepcopy(doc);for(var op in mod){var mod_func=Collection._modifiers[op];if(!mod_func)throw Error("Invalid modifier specified "+op);for(var keypath in mod[op]){if(keypath.length&&keypath[keypath.length-1]===".")throw Error("Invalid mod field name, may not end in a period");var arg=mod[op][keypath],keyparts=keypath.split("."),no_create=!!Collection._noCreateModifiers[op],forbid_array=op==="$rename",target=Collection._findModTarget(new_doc,keyparts,no_create,forbid_array),field=keyparts.pop();mod_func(target,field,arg,keypath,new_doc)}}}for(var k in doc)k!=="_id"&&delete doc[k];for(var k in new_doc)doc[k]=new_doc[k]},Collection._findModTarget=function(doc,keyparts,no_create,forbid_array){for(var i=0;i<keyparts.length;i++){var last=i===keyparts.length-1,keypart=keyparts[i],numeric=/^[0-9]+$/.test(keypart);if(!(!no_create||typeof doc=="object"&&keypart in doc))return undefined;if(doc instanceof Array){if(forbid_array)return null;if(!numeric)throw Error("can't append to array using string field name ["+keypart+"]");keypart=parseInt(keypart),last&&(keyparts[i]=keypart);while(doc.length<keypart)doc.push(null);if(!last)if(doc.length===keypart)doc.push({});else if(typeof doc[keypart]!="object")throw Error("can't modify field '"+keyparts[i+1]+"' of list value "+JSON.stringify(doc[keypart]))}else!last&&!(keypart in doc)&&(doc[keypart]={});if(last)return doc;doc=doc[keypart]}},Collection._noCreateModifiers={$unset:!0,$pop:!0,$rename:!0,$pull:!0,$pullAll:!0},Collection._modifiers={$inc:function(target,field,arg){if(typeof arg!="number")throw Error("Modifier $inc allowed for numbers only");if(field in target){if(typeof target[field]!="number")throw Error("Cannot apply $inc modifier to non-number"
);target[field]+=arg}else target[field]=arg},$set:function(target,field,arg){target[field]=Collection._deepcopy(arg)},$unset:function(target,field,arg){target!==undefined&&(target instanceof Array?field in target&&(target[field]=null):delete target[field])},$push:function(target,field,arg){var x=target[field];if(x===undefined)target[field]=[arg];else{if(!(x instanceof Array))throw Error("Cannot apply $push modifier to non-array");x.push(Collection._deepcopy(arg))}},$pushAll:function(target,field,arg){if(!(typeof arg=="object"&&arg instanceof Array))throw Error("Modifier $pushAll/pullAll allowed for arrays only");var x=target[field];if(x===undefined)target[field]=arg;else{if(!(x instanceof Array))throw Error("Cannot apply $pushAll modifier to non-array");for(var i=0;i<arg.length;i++)x.push(arg[i])}},$addToSet:function(target,field,arg){var x=target[field];if(x===undefined)target[field]=[arg];else{if(!(x instanceof Array))throw Error("Cannot apply $addToSet modifier to non-array");var isEach=!1;if(typeof arg=="object")for(var k in arg){k==="$each"&&(isEach=!0);break}var values=isEach?arg.$each:[arg];_.each(values,function(value){for(var i=0;i<x.length;i++)if(Collection._f._equal(value,x[i]))return;x.push(value)})}},$pop:function(target,field,arg){if(target===undefined)return;var x=target[field];if(x===undefined)return;if(!(x instanceof Array))throw Error("Cannot apply $pop modifier to non-array");typeof arg=="number"&&arg<0?x.splice(0,1):x.pop()},$pull:function(target,field,arg){if(target===undefined)return;var x=target[field];if(x===undefined)return;if(!(x instanceof Array))throw Error("Cannot apply $pull/pullAll modifier to non-array");var out=[];if(typeof arg!="object"||arg instanceof Array)for(var i=0;i<x.length;i++)Collection._f._equal(x[i],arg)||out.push(x[i]);else{var match=Collection._compileSelector(arg);for(var i=0;i<x.length;i++)match(x[i])||out.push(x[i])}target[field]=out},$pullAll:function(target,field,arg){if(!(typeof arg=="object"&&arg instanceof Array))throw Error("Modifier $pushAll/pullAll allowed for arrays only");if(target===undefined)return;var x=target[field];if(x===undefined)return;if(!(x instanceof Array))throw Error("Cannot apply $pull/pullAll modifier to non-array");var out=[];for(var i=0;i<x.length;i++){var exclude=!1;for(var j=0;j<arg.length;j++)if(Collection._f._equal(x[i],arg[j])){exclude=!0;break}exclude||out.push(x[i])}target[field]=out},$rename:function(target,field,arg,keypath,doc){if(keypath===arg)throw Error("$rename source must differ from target");if(target===null)throw Error("$rename source field invalid");if(typeof arg!="string")throw Error("$rename target must be a string");if(target===undefined)return;var v=target[field];delete target[field];var keyparts=arg.split("."),target2=Collection._findModTarget(doc,keyparts,!1,!0);if(target2===null)throw Error("$rename target field invalid");var field2=keyparts.pop();target2[field2]=v},$bit:function(target,field,arg){throw Error("$bit is not supported")}};var Selector={};Selector._f={_all:function(x,qval){if(x instanceof Array){var parts={},remaining=0;utils.each(qval,function(q){var hash=JSON.stringify(q);hash in parts||(parts[hash]=!0,remaining++)});for(var i=0;i<x.length;i++){var hash=JSON.stringify(x[i]);if(parts[hash]){delete parts[hash],remaining--;if(0===remaining)return!0}}return!1}return!1},_in:function(x,qval){if(typeof x!="object"){for(var i=0;i<qval.length;i++)if(x===qval[i])return!0;return!1}for(var i=0;i<qval.length;i++)if(Selector._f._equal(x,qval[i]))return!0;return!1},_type:function(v){return typeof v=="number"?1:typeof v=="string"?2:typeof v=="boolean"?8:v instanceof Array?4:v===null?10:v instanceof RegExp?11:typeof v=="function"?13:3},_equal:function(x,qval){var match=function(a,b){if(typeof a=="number"||typeof a=="string"||typeof a=="boolean"||a===undefined||a===null)return a===b;if(typeof a=="function")return!1;if(typeof b!="object")return!1;if(a instanceof Array){if(b instanceof Array){if(a.length!==b.length)return!1;for(var i=0;i<a.length;i++)if(!match(a[i],b[i]))return!1;return!0}return!1}var b_keys=[];for(var x in b)b_keys.push(b[x]);var i=0;for(var x in a){if(i>=b_keys.length)return!1;if(!match(a[x],b_keys[i]))return!1;i++}return i!==b_keys.length?!1:!0};return match(x,qval)},_matches:function(x,f){if(x instanceof Array){for(var i=0;i<x.length;i++)if(f(x[i]))return!0;return!1}return f(x)},_matches_plus:function(x,f){if(x instanceof Array)for(var i=0;i<x.length;i++)if(f(x[i]))return!0;return f(x)},_typeorder:function(t){return[-1,1,2,3,4,5,-1,6,7,8,0,9,-1,100,2,100,1,8,1][t]},_cmp:function(a,b){if(a===undefined)return b===undefined?0:-1;if(b===undefined)return 1;var ta=Selector._f._type(a),tb=Selector._f._type(b),oa=Selector._f._typeorder(ta),ob=Selector._f._typeorder(tb);if(oa!==ob)return oa<ob?-1:1;if(ta!==tb)throw Error("Missing type coercion logic in _cmp");if(ta===1)return a-b;if(tb===2)return a<b?-1:a===b?0:1;if(ta===3){var to_array=function(obj){var ret=[];for(var key in obj)ret.push(key),ret.push(obj[key]);return ret};return Selector._f._cmp(to_array(a),to_array(b))}if(ta===4)for(var i=0;;i++){if(i===a.length)return i===b.length?0:-1;if(i===b.length)return 1;var s=Selector._f._cmp(a[i],b[i]);if(s!==0)return s}if(ta===8)return a?b?0:1:b?-1:0;if(ta===10)return 0;if(ta===11)throw Error("Sorting not supported on regular expression");if(ta===13)throw Error("Sorting not supported on Javascript code")}},Selector._matches=function(selector,doc){return Selector._compileSelector(selector)(doc)},Selector._compileSelector=function(selector){var literals=[];if(selector instanceof Function)return function(doc){return selector.call(doc)};if(typeof selector=="string"||typeof selector=="number")selector={_id:selector};if(!selector||"_id"in selector&&!selector._id)return function(doc){return!1};var _func;return eval("_func = (function(f,literals){return function(doc){return "+Selector._exprForSelector(selector,literals)+";};})"),_func(Selector._f,literals)},Selector._exprForSelector=function(selector,literals){var clauses=[];for(var key in selector){var value=selector[key];key.substr(0,1)==="$"?clauses.push(Selector._exprForDocumentPredicate(key,value,literals)):clauses.push(Selector._exprForKeypathPredicate(key,value,literals))}return clauses.length===0?"true":"("+clauses.join("&&")+")"},Selector._exprForDocumentPredicate=function(op,value,literals){if(op==="$or"){var clauses=[];return utils.each(value,function(c){clauses.push(Selector._exprForSelector(c,literals))}),clauses.length===0?"true":"("+clauses.join("||")+")"}if(op==="$and"){var clauses=[];return utils.each(value,function(c){clauses.push(Selector._exprForSelector(c,literals))}),clauses.length===0?"true":"("+clauses.join("&&")+")"}if(op==="$nor"){var clauses=[];return utils.each(value,function(c){clauses.push("!("+Selector._exprForSelector(c,literals)+")")}),clauses.length===0?"true":"("+clauses.join("&&")+")"}if(op==="$where")return value instanceof Function?(literals.push(value),"literals["+(literals.length-1)+"].call(doc)"):"(function(){return "+value+";}).call(doc)";throw Error("Unrecogized key in selector: ",op)},Selector._exprForKeypathPredicate=function(keypath,value,literals){var keyparts=keypath.split("."),predcode="";if(value instanceof RegExp)predcode=Selector._exprForOperatorTest(value,literals);else if(typeof value!="object"||value===null||value instanceof Array)predcode=Selector._exprForValueTest(value,literals);else{var is_literal=!0;for(var k in value)if(k.substr(0,1)==="$"){is_literal=!1;break}is_literal?predcode=Selector._exprForValueTest(value,literals):predcode=Selector._exprForOperatorTest(value,literals)}var ret="",innermost=!0;while(keyparts.length){var part=keyparts.pop(),formal=keyparts.length?"x":"doc";innermost?(ret="(function(x){return "+predcode+";})("+formal+"&&"+formal+"["+JSON.stringify(part)+"])",innermost=!1):ret="f._matches("+formal+"&&"+formal+"["+JSON.stringify(part)+"], function(x){return "+ret+";})"}return ret},Selector._exprForValueTest=function(value,literals){var expr;if(value===null)expr="x===null||x===undefined";else if(typeof value=="string"||typeof value=="number"||typeof value=="boolean")expr="x==="+JSON.stringify(value);else{if(typeof value=="function")throw Error("Bad value type in query");expr="f._equal(x,"+JSON.stringify(value)+")"}return"f._matches_plus(x,function(x){return "+expr+";})"},Selector._exprForOperatorTest=function(op,literals){if(op instanceof RegExp)return Selector._exprForOperatorTest({$regex:op},literals);var clauses=[];for(var type in op)clauses.push(Selector._exprForConstraint(type,op[type],op,literals));return clauses.length===0?"true":"("+clauses.join("&&")+")"},Selector._exprForConstraint=function(type,arg,others,literals){var expr,search="_matches",negate=!1;if(type==="$gt")expr="f._cmp(x,"+JSON.stringify(arg)+")>0";else if(type==="$lt")expr="f._cmp(x,"+JSON.stringify(arg)+")<0";else if(type==="$gte")expr="f._cmp(x,"+JSON.stringify(arg)+")>=0";else if(type==="$lte")expr="f._cmp(x,"+JSON.stringify(arg)+")<=0";else if(type==="$all")expr="f._all(x,"+JSON.stringify(arg)+")",search=null;else if(type==="$exists")arg?expr="x!==undefined":expr="x===undefined",search=null;else if(type==="$mod")expr="x%"+JSON.stringify(arg[0])+"==="+JSON.stringify(arg[1]);else if(type==="$ne")typeof arg!="object"?expr="x==="+JSON.stringify(arg):expr="f._equal(x,"+JSON.stringify(arg)+")",search="_matches_plus",negate=!0;else if(type==="$in")expr="f._in(x,"+JSON.stringify(arg)+")",search="_matches_plus";else if(type==="$nin")expr="f._in(x,"+JSON.stringify(arg)+")",search="_matches_plus",negate=!0;else if(type==="$size")expr="(x instanceof Array)&&x.length==="+arg,search=null;else if(type==="$type")expr="f._type(x)==="+JSON.stringify(arg);else if(type==="$regex"){if("$options"in others&&/[^gim]/.test(others.$options))throw Error("Only the i, m, and g regexp options are supported");expr="literals["+literals.length+"].test(x)",arg instanceof RegExp?"$options"in others?literals.push(new RegExp(arg.source,others.$options)):literals.push(arg):literals.push(new RegExp(arg,others.$options))}else if(type==="$options")expr="true",search=null;else{if(type==="$elemMatch")throw Error("$elemMatch unimplemented");if(type!=="$not")throw Error("Unrecognized key in selector: "+type);expr="!"+Selector._exprForOperatorTest(arg,literals),search=null}return search&&(expr="f."+search+"(x,function(x){return "+expr+";})"),negate&&(expr="!"+expr),expr},Collection._compileSort=function(spec){var keys=[],asc=[];if(spec instanceof Array)for(var i=0;i<spec.length;i++)typeof spec[i]=="string"?(keys.push(spec[i]),asc.push(!0)):(keys.push(spec[i][0]),asc.push(spec[i][1]!=="desc"));else{if(typeof spec!="object")throw Error("Bad sort specification: ",JSON.stringify(spec));for(key in spec)keys.push(key),asc.push(!(spec[key]<0))}if(keys.length===0)return function(){return 0};var _func,code="_func = (function(c){return function(a,b){var x;";for(var i=0;i<keys.length;i++)i!==0&&(code+="if(x!==0)return x;"),code+="x="+(asc[i]?"":"-")+"c(a["+JSON.stringify(keys[i])+"],b["+JSON.stringify(keys[i])+"]);";return code+="return x;};})",eval(code),_func(Collection._f._cmp)};var Utils={};Utils._deepcopy=function(v){if(typeof v!="object")return v;if(v===null)return null;if(utils.isArray(v)){var ret=v.slice(0);for(var i=0;i<v.length;i++)ret[i]=Utils._deepcopy(ret[i]);return ret}var ret={};for(var key in v)ret[key]=Utils._deepcopy(v[key]);return ret},Utils.each=Utils.forEach=function(obj,iterator,context){if(obj===null)return;var nativeForEach=Array.prototype.forEach;if(nativeForEach&&obj.forEach===nativeForEach)obj.forEach(iterator,context);else if(obj.length===+obj.length){for(var i=0,l=obj.length;i<l;i++)if(iterator.call(context,obj[i],i,obj)===breaker)return}else for(var key in obj)if(_.has(obj,key)&&iterator.call(context,obj[key],key,obj)===breaker)return},Utils.isArray=Array.isArray||function(obj){return toString.call(obj)=="[object Array]"},Utils.debug=function(data){};var utils=Utils;